<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Contagem de Produtos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    label {
      margin-top: 15px;
      display: block;
      font-weight: bold;
    }

    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
    }

    .vencimento-grupo {
      background: #fff;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 10px;
      border-radius: 10px;
    }

    .mensagem {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 20px;
      white-space: pre-wrap;
    }

    .scanner-btn {
      background: #007bff;
      color: #fff;
      border: none;
      margin-top: 10px;
      cursor: pointer;
    }

    .scanner-btn:hover {
      background: #0056b3;
    }

    .adicionar-btn {
      background: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 20px;
    }

    .adicionar-btn:hover {
      background: #218838;
    }

    #scanner-container {
      display: none;
      margin: 10px 0;
      position: relative;
    }

    video {
      width: 100%;
      border-radius: 10px;
    }

    .fechar-scanner {
      position: absolute;
      top: 10px;
      right: 10px;
      background: red;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2>Contagem de Produtos</h2>

  <label>Produto</label>
  <input type="text" id="produto" placeholder="Ex: Leite Integral 1L">

  <label>C√≥digo de Barras</label>
  <input type="text" id="codigo-barra" readonly>

  <button class="scanner-btn" onclick="iniciarScanner()">üì∑ Escanear C√≥digo de Barras</button>
  <div id="scanner-container">
    <video id="scanner-preview"></video>
    <button class="fechar-scanner" onclick="fecharScanner()">Fechar</button>
  </div>

  <label>Loja</label>
  <input type="text" id="loja" placeholder="Ex: Loja Central">

  <div id="vencimentos"></div>
  <button class="adicionar-btn" onclick="adicionarVencimento()">+ Adicionar outra contagem</button>

  <label style="margin-top: 25px;">Observa√ß√µes</label>
  <textarea id="obs" rows="3" placeholder="Ex: Produto na geladeira da frente"></textarea>

  <button onclick="gerarMensagem()">Gerar Mensagem</button>
  <div class="mensagem" id="mensagem"></div>
  <button onclick="copiarMensagem()">Copiar Mensagem</button>

  <script>
    // Adiciona novo grupo de vencimento
    function adicionarVencimento() {
      const container = document.getElementById('vencimentos');
      const grupo = document.createElement('div');
      grupo.className = 'vencimento-grupo';
      grupo.innerHTML = `
        <div style="display: flex; gap: 10px;">
          <input type="number" class="quantidade" placeholder="Quantidade" style="flex: 1;">
          <select class="unidade" style="width: 80px;">
            <option value="UN">UN</option>
            <option value="KG">KG</option>
          </select>
        </div>
        <input type="text" class="vencimento" placeholder="Data de vencimento (dd/mm/aaaa)" oninput="mascaraData(this)" maxlength="10">
        <select class="local">
          <option value="√Årea de vendas">√Årea de vendas</option>
          <option value="Estoque">Estoque</option>
        </select>
      `;
      container.appendChild(grupo);
    }

    // M√°scara para o campo de data
    function mascaraData(campo) {
      let v = campo.value.replace(/\D/g, "");
      if (v.length > 2 && v.length <= 4) {
        campo.value = v.replace(/^(\d{2})(\d{1,2})/, "$1/$2");
      } else if (v.length > 4) {
        campo.value = v.replace(/^(\d{2})(\d{2})(\d{1,4}).*/, "$1/$2/$3");
      } else {
        campo.value = v;
      }
    }

    // Gera a mensagem final
    function gerarMensagem() {
      const produto = document.getElementById('produto').value.trim();
      const loja = document.getElementById('loja').value.trim();
      const obs = document.getElementById('obs').value.trim();
      const grupos = document.querySelectorAll('.vencimento-grupo');

      if (!produto || !loja || grupos.length === 0) {
        alert('Preencha produto, loja e ao menos uma contagem.');
        return;
      }

      let mensagem = `üì¶ Produto: ${produto}\n\n`;
      mensagem += `üè¨ Loja: ${loja}\n\n`;
      mensagem += `üìÖ Contagem:\n`;

      grupos.forEach((grupo) => {
        const qtd = grupo.querySelector('.quantidade').value.trim();
        const und = grupo.querySelector('.unidade').value;
        const venc = grupo.querySelector('.vencimento').value.trim();
        const local = grupo.querySelector('.local').value;

        if (qtd && venc && local) {
          if (!/^\d{2}\/\d{2}\/\d{4}$/.test(venc)) {
            alert(`Data inv√°lida: ${venc}. Use o formato dd/mm/aaaa.`);
            return;
          }
          mensagem += `‚Ä¢ ${qtd} ${und} (${local}) - ${venc}\n`;
        }
      });

      if (obs) mensagem += `\nüìù Obs: ${obs}`;

      document.getElementById('mensagem').textContent = mensagem;
    }

    // Copia a mensagem para a √°rea de transfer√™ncia
    function copiarMensagem() {
      const texto = document.getElementById('mensagem').textContent;
      if (!texto) return alert('Gere uma mensagem primeiro.');
      navigator.clipboard.writeText(texto).then(() => {
        alert('Mensagem copiada! Cole no WhatsApp ou onde quiser.');
      });
    }

    // Inicia o scanner
    function iniciarScanner() {
      const scannerContainer = document.getElementById('scanner-container');
      const video = document.getElementById('scanner-preview');
      scannerContainer.style.display = 'block';

      Quagga.init({
        inputStream: {
          type: "LiveStream",
          target: video,
          constraints: {
            facingMode: "environment"
          }
        },
        decoder: {
          readers: ["ean_reader"]
        }
      }, function (err) {
        if (err) {
          console.error(err);
          alert("Erro ao iniciar scanner");
          return;
        }
        Quagga.start();
      });

      Quagga.onDetected(async function (result) {
        const code = result.codeResult.code;
        Quagga.stop();
        scannerContainer.style.display = 'none';
        document.getElementById('codigo-barra').value = code;
        document.getElementById('produto').value = code;

        try {
          const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
          const data = await res.json();
          if (data.status === 1 && data.product.product_name) {
            document.getElementById('produto').value = data.product.product_name;
          } else {
            alert("C√≥digo escaneado, mas produto n√£o encontrado.");
          }
        } catch (e) {
          console.error(e);
          alert("Erro ao buscar o nome do produto.");
        }
      });
    }

    // Fecha o scanner
    function fecharScanner() {
      Quagga.stop();
      document.getElementById('scanner-container').style.display = 'none';
    }

    // Fecha scanner ao clicar fora
    document.addEventListener('click', function (e) {
      const container = document.getElementById('scanner-container');
      if (container.style.display === 'block' && !container.contains(e.target)) {
        fecharScanner();
      }
    });

    // Inicializa com um campo
    adicionarVencimento();
  </script>
</body>
</html>
